<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MyPlanner â€“ To-Do, Lista della Spesa & Comparazione Prezzi</title>
  <style>
    :root {
      --bg-color-light: #f0f2f5;
      --text-color-light: #333;
      --card-color-light: #fff;
      --border-color-light: #ddd;

      --bg-color-dark: #1e1e1e;
      --text-color-dark: #e0e0e0;
      --card-color-dark: #2c2c2c;
      --border-color-dark: #444;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: var(--bg-color-light);
      color: var(--text-color-light);
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark {
      background-color: var(--bg-color-dark);
      color: var(--text-color-dark);
    }
    header {
      background-color: var(--card-color-light);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
      transition: background-color 0.3s;
    }
    body.dark header {
      background-color: var(--card-color-dark);
    }
    nav {
      max-width: 900px;
      margin: auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
    }
    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      color: #007bff;
    }
    .nav-links {
      display: flex;
      gap: 20px;
    }
    .nav-link {
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
      font-size: 1rem;
    }
    .nav-link.active {
      background-color: #e0e7ff;
      color: #007bff;
    }
    body.dark .nav-link.active {
      background-color: #444;
      color: #66aaff;
    }

    .container {
      max-width: 900px;
      margin: 20px auto;
      padding: 0 20px;
    }

    h2 {
      margin-bottom: 20px;
      text-align: center;
    }

    .page {
      display: none;
      background-color: var(--card-color-light);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 40px;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark .page {
      background-color: var(--card-color-dark);
      color: var(--text-color-dark);
    }
    .page.active {
      display: block;
    }

    /* ==========================
       To-Do List Styles
    =========================== */
    #todo-page .new-list-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 20px;
    }
    #todo-page .new-list-form input[type="text"] {
      flex: 1 1 200px;
      padding: 8px;
      font-size: 14px;
      border: 1px solid var(--border-color-light);
      border-radius: 4px;
      background-color: inherit;
      color: inherit;
      transition: border-color 0.3s, background-color 0.3s, color 0.3s;
    }
    body.dark #todo-page .new-list-form input {
      border-color: var(--border-color-dark);
    }
    #todo-page .new-list-form button {
      padding: 8px 16px;
      font-size: 14px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #todo-page .new-list-form button:hover {
      background-color: #0056b3;
    }
    #todo-page #lists-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    #todo-page .todo-list-card {
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border-color-light);
      border-radius: 8px;
      padding: 15px;
      transition: border-color 0.3s, background-color 0.3s;
    }
    body.dark #todo-page .todo-list-card {
      border-color: var(--border-color-dark);
    }
    #todo-page .todo-list-card h3 {
      font-size: 1.2rem;
      margin-bottom: 12px;
      text-align: center;
      cursor: pointer;
    }
    #todo-page .task-form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }
    #todo-page .task-form input[type="text"],
    #todo-page .task-form input[name="description"] {
      flex: 1 1 120px;
      padding: 6px;
      font-size: 13px;
      border: 1px solid var(--border-color-light);
      border-radius: 4px;
      background-color: inherit;
      color: inherit;
      transition: border-color 0.3s;
    }
    body.dark #todo-page .task-form input {
      border-color: var(--border-color-dark);
    }
    #todo-page .task-form button {
      padding: 6px 12px;
      font-size: 13px;
      background-color: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #todo-page .task-form button:hover {
      background-color: #218838;
    }
    #todo-page .list-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
    }
    #todo-page .list-section h4 {
      margin-bottom: 6px;
      font-size: 0.95rem;
      border-bottom: 1px solid var(--border-color-light);
      padding-bottom: 4px;
    }
    body.dark #todo-page .list-section h4 {
      border-color: var(--border-color-dark);
    }
    #todo-page .task-items {
      list-style: none;
      padding-left: 0;
      margin: 0;
      flex: 1;
      overflow-y: auto;
    }
    #todo-page .task-items li {
      display: flex;
      flex-direction: column;
      padding: 6px 0;
      border-bottom: 1px solid var(--border-color-light);
    }
    body.dark #todo-page .task-items li {
      border-color: var(--border-color-dark);
    }
    #todo-page .task-items li:last-child {
      border-bottom: none;
    }
    #todo-page .task-content {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #todo-page .task-label,
    #todo-page .task-label-edit {
      flex: 1;
      font-size: 14px;
      cursor: pointer;
    }
    #todo-page .task-desc,
    #todo-page .task-desc-edit {
      margin-left: 24px;
      font-size: 12px;
      color: gray;
      cursor: pointer;
    }
    #todo-page .task-label-edit,
    #todo-page .task-desc-edit {
      border: 1px solid var(--border-color-light);
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 14px;
      background-color: inherit;
      color: inherit;
      transition: border-color 0.3s;
    }
    body.dark #todo-page .task-label-edit,
    body.dark #todo-page .task-desc-edit {
      border-color: var(--border-color-dark);
    }
    #todo-page .done .task-label {
      text-decoration: line-through;
      color: #888;
    }
    #todo-page .delete-list-button {
      margin-top: 10px;
      padding: 6px;
      font-size: 12px;
      background-color: #dc3545;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      align-self: center;
      transition: background-color 0.2s;
    }
    #todo-page .delete-list-button:hover {
      background-color: #c82333;
    }

    /* ==========================
       Lista della Spesa Styles
    =========================== */
    #shopping-page .new-item-form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }
    #shopping-page .new-item-form input[type="text"],
    #shopping-page .new-item-form input[name="description"] {
      flex: 1 1 150px;
      padding: 8px;
      font-size: 14px;
      border: 1px solid var(--border-color-light);
      border-radius: 4px;
      background-color: inherit;
      color: inherit;
      transition: border-color 0.3s;
    }
    body.dark #shopping-page .new-item-form input {
      border-color: var(--border-color-dark);
    }
    #shopping-page .new-item-form button {
      padding: 8px 16px;
      font-size: 14px;
      background-color: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #shopping-page .new-item-form button:hover {
      background-color: #218838;
    }
    #shopping-page .list-section {
      margin-bottom: 20px;
    }
    #shopping-page .list-section h4 {
      margin-bottom: 10px;
      font-size: 0.95rem;
      border-bottom: 2px solid var(--border-color-light);
      padding-bottom: 5px;
    }
    body.dark #shopping-page .list-section h4 {
      border-color: var(--border-color-dark);
    }
    #shopping-page ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    #shopping-page li {
      display: flex;
      flex-direction: column;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color-light);
    }
    body.dark #shopping-page li {
      border-color: var(--border-color-dark);
    }
    #shopping-page li:last-child {
      border-bottom: none;
    }
    #shopping-page .item-content {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #shopping-page .item-info,
    #shopping-page .item-info-edit {
      display: flex;
      align-items: baseline;
      gap: 8px;
      flex: 1;
      font-size: 14px;
      cursor: pointer;
    }
    #shopping-page .item-desc,
    #shopping-page .item-desc-edit {
      margin-left: 24px;
      font-size: 12px;
      color: gray;
      cursor: pointer;
    }
    #shopping-page .item-info-edit input[type="text"],
    #shopping-page .item-info-edit input[name="description"] {
      border: 1px solid var(--border-color-light);
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 14px;
      background-color: inherit;
      color: inherit;
      transition: border-color 0.3s;
    }
    body.dark #shopping-page .item-info-edit input {
      border-color: var(--border-color-dark);
    }
    #shopping-page .done .item-info {
      text-decoration: line-through;
      color: #888;
    }
    #shopping-page .delete-item-button {
      margin-top: 6px;
      align-self: flex-end;
      padding: 4px 8px;
      font-size: 12px;
      background-color: #dc3545;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
      display: none;
    }
    #shopping-page .delete-item-button:hover {
      background-color: #c82333;
    }

    /* ==========================
       Comparazione Prezzi Styles
    =========================== */
    #comparison-page .forms-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      justify-content: center;
    }
    #comparison-page .forms-row form {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    #comparison-page .forms-row input[type="text"] {
      padding: 6px;
      font-size: 14px;
      border: 1px solid var(--border-color-light);
      border-radius: 4px;
      background-color: inherit;
      color: inherit;
      transition: border-color 0.3s;
    }
    body.dark #comparison-page .forms-row input {
      border-color: var(--border-color-dark);
    }
    #comparison-page .forms-row button {
      padding: 6px 12px;
      font-size: 14px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #comparison-page .forms-row button:hover {
      background-color: #0069d9;
    }
    #comparison-page #comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      transition: background-color 0.3s, color 0.3s;
    }
    #comparison-page #comparison-table th,
    #comparison-page #comparison-table td {
      border: 1px solid var(--border-color-light);
      padding: 8px;
      text-align: center;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    body.dark #comparison-page #comparison-table th,
    body.dark #comparison-page #comparison-table td {
      border-color: var(--border-color-dark);
    }
    #comparison-page #comparison-table th {
      background-color: var(--card-color-light);
      cursor: pointer;
      position: relative;
    }
    body.dark #comparison-page #comparison-table th {
      background-color: var(--card-color-dark);
    }
    #comparison-page #comparison-table th span {
      flex: 1;
    }
    #comparison-page #comparison-table th input.edit-input {
      width: 80%;
      padding: 4px;
      font-size: 13px;
      border: 1px solid var(--border-color-light);
      border-radius: 4px;
      background-color: inherit;
      color: inherit;
      transition: border-color 0.3s;
    }
    body.dark #comparison-page #comparison-table th input {
      border-color: var(--border-color-dark);
    }
    #comparison-page #comparison-table td input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 4px;
      font-size: 14px;
      border: 1px solid var(--border-color-light);
      border-radius: 4px;
      text-align: center;
      background-color: inherit;
      color: inherit;
      transition: border-color 0.3s;
    }
    body.dark #comparison-page #comparison-table td input {
      border-color: var(--border-color-dark);
    }
    #comparison-page .delete-button {
      background-color: #dc3545;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #comparison-page .delete-button:hover {
      background-color: #c82333;
    }
    #comparison-page .lowest-price {
      background-color: #d4edda; /* verde chiaro */
    }

    /* Responsive */
    @media (max-width: 600px) {
      nav {
        flex-direction: column;
        gap: 10px;
      }
      .nav-links {
        justify-content: center;
        flex-wrap: wrap;
      }
      #todo-page .todo-list-card,
      #shopping-page li,
      #comparison-page #comparison-table,
      #comparison-page .forms-row {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <div class="logo">MyPlanner</div>
      <div class="nav-links">
        <div class="nav-link active" data-target="todo-page">Cose da Fare</div>
        <div class="nav-link" data-target="shopping-page">Lista della Spesa</div>
        <div class="nav-link" data-target="comparison-page">Comparazione Prezzi</div>
        <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“ Tema</button>
      </div>
    </nav>
  </header>

  <div class="container">
    <!-- To-Do Page -->
    <section id="todo-page" class="page active">
      <h2>Cose da Fare</h2>
      <form id="new-list-form" class="new-list-form">
        <input type="text" id="new-list-input" placeholder="Nome nuova lista..." required>
        <button type="submit">Crea Lista</button>
      </form>
      <div id="lists-container"></div>
    </section>

    <!-- Shopping Page -->
    <section id="shopping-page" class="page">
      <h2>Lista della Spesa</h2>
      <form id="new-item-form" class="new-item-form">
        <input type="text" id="item-name-input" placeholder="Nome prodotto..." required>
        <input type="text" id="item-qty-input" placeholder="QuantitÃ  o peso..." required>
        <input type="text" id="item-desc-input" name="description" placeholder="Descrizione (opzionale)...">
        <button type="submit">Aggiungi</button>
      </form>
      <div class="list-section">
        <h4>Da Comprare</h4>
        <ul id="shopping-todo-list"></ul>
      </div>
      <div class="list-section">
        <h4>Comprato</h4>
        <ul id="shopping-done-list"></ul>
      </div>
    </section>

    <!-- Comparison Page -->
    <section id="comparison-page" class="page">
      <h2>Comparazione Prezzi</h2>
      <div class="forms-row">
        <form id="add-product-form">
          <label for="product-name-input">Nuovo Prodotto:</label>
          <input type="text" id="product-name-input" placeholder="Nome prodotto..." required>
          <button type="submit">Aggiungi Prodotto</button>
        </form>
        <form id="add-store-form">
          <label for="store-name-input">Nuovo Supermercato:</label>
          <input type="text" id="store-name-input" placeholder="Nome supermercato..." required>
          <button type="submit">Aggiungi Supermercato</button>
        </form>
      </div>
      <table id="comparison-table">
        <thead>
          <tr>
            <th><span>Supermercato</span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <script>
    // NAVIGATION TABS
    const navLinks = document.querySelectorAll('.nav-link');
    const pages = document.querySelectorAll('.page');
    navLinks.forEach(link => {
      link.addEventListener('click', () => {
        navLinks.forEach(l => l.classList.remove('active'));
        pages.forEach(p => p.classList.remove('active'));
        link.classList.add('active');
        document.getElementById(link.dataset.target).classList.add('active');
      });
    });

    /* ==========================
       THEME TOGGLE & PERSISTENCE
    =========================== */
    function setTheme(mode) {
      if (mode === 'dark') {
        document.body.classList.add('dark');
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.classList.remove('dark');
        localStorage.setItem('theme', 'light');
      }
    }
    function toggleTheme() {
      const isDark = document.body.classList.contains('dark');
      setTheme(isDark ? 'light' : 'dark');
    }
    (function() {
      const saved = localStorage.getItem('theme');
      if (saved === 'dark') setTheme('dark');
    })();

    /* ==========================
       TODO LIST WITH EDITABLE LIST NAME & DESCRIPTIONS
    =========================== */
    const TODO_STORAGE_KEY = 'myplanner_todos';
    const newListForm = document.getElementById('new-list-form');
    const newListInput = document.getElementById('new-list-input');
    const listsContainer = document.getElementById('lists-container');
    let listCounter = 0;
    let todosData = []; 
    // Structure: [ { id, name, tasks: [ { text, desc, done } ] } ]

    newListForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const listName = newListInput.value.trim();
      if (!listName) return;
      listCounter++;
      const thisListId = 'todo-list-' + Date.now() + '-' + listCounter;
      const newListObj = { id: thisListId, name: listName, tasks: [] };
      todosData.push(newListObj);
      saveTodos();
      createTodoList(newListObj);
      newListInput.value = '';
      newListInput.focus();
    });

    function createTodoList(listObj) {
      const card = document.createElement('div');
      card.classList.add('todo-list-card');
      card.setAttribute('data-list-id', listObj.id);

      const header = document.createElement('h3');
      const headerSpan = document.createElement('span');
      headerSpan.textContent = listObj.name;
      header.appendChild(headerSpan);
      card.appendChild(header);

      // Double-click or tap to edit list name
      function enableHeaderEdit() {
        const oldName = headerSpan.textContent;
        const inputEdit = document.createElement('input');
        inputEdit.type = 'text';
        inputEdit.value = oldName;
        inputEdit.classList.add('task-label-edit');
        header.replaceChild(inputEdit, headerSpan);
        inputEdit.focus();

        function saveHeaderEdit() {
          const newName = inputEdit.value.trim();
          if (newName) {
            const listData = todosData.find(l => l.id === listObj.id);
            listData.name = newName;
            saveTodos();
            headerSpan.textContent = newName;
            header.replaceChild(headerSpan, inputEdit);
          } else {
            header.replaceChild(headerSpan, inputEdit);
          }
        }

        inputEdit.addEventListener('blur', saveHeaderEdit);
        inputEdit.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            saveHeaderEdit();
          } else if (e.key === 'Escape') {
            header.replaceChild(headerSpan, inputEdit);
          }
        });
      }
      headerSpan.addEventListener('dblclick', enableHeaderEdit);
      headerSpan.addEventListener('touchend', (e) => {
        e.preventDefault();
        enableHeaderEdit();
      });

      const taskForm = document.createElement('form');
      taskForm.classList.add('task-form');
      taskForm.setAttribute('data-list-id', listObj.id);

      const taskInput = document.createElement('input');
      taskInput.type = 'text';
      taskInput.placeholder = 'Nuova attivitÃ ...';
      taskInput.required = true;

      const descInput = document.createElement('input');
      descInput.type = 'text';
      descInput.name = 'description';
      descInput.placeholder = 'Descrizione (opzionale)...';

      const addTaskBtn = document.createElement('button');
      addTaskBtn.textContent = 'Aggiungi';

      taskForm.appendChild(taskInput);
      taskForm.appendChild(descInput);
      taskForm.appendChild(addTaskBtn);
      card.appendChild(taskForm);

      const todoSection = document.createElement('div');
      todoSection.classList.add('list-section');
      const todoHeader = document.createElement('h4');
      todoHeader.textContent = 'DA FARE';
      const todoUl = document.createElement('ul');
      todoUl.classList.add('task-items');
      todoUl.setAttribute('data-type', 'todo');
      todoSection.appendChild(todoHeader);
      todoSection.appendChild(todoUl);
      card.appendChild(todoSection);

      const doneSection = document.createElement('div');
      doneSection.classList.add('list-section');
      const doneHeader = document.createElement('h4');
      doneHeader.textContent = 'FATTO';
      const doneUl = document.createElement('ul');
      doneUl.classList.add('task-items');
      doneUl.setAttribute('data-type', 'done');
      doneSection.appendChild(doneHeader);
      doneSection.appendChild(doneUl);
      card.appendChild(doneSection);

      const deleteListBtn = document.createElement('button');
      deleteListBtn.classList.add('delete-list-button');
      deleteListBtn.textContent = 'Elimina Lista';
      deleteListBtn.addEventListener('click', () => {
        if (confirm(`Sei sicuro di voler eliminare la lista â€œ${listObj.name}â€?`)) {
          listsContainer.removeChild(card);
          todosData = todosData.filter(l => l.id !== listObj.id);
          saveTodos();
        }
      });
      card.appendChild(deleteListBtn);

      listsContainer.appendChild(card);
      configureTodoListeners(card, listObj);

      // Ripopolare eventuali task salvate
      listObj.tasks.forEach(task => {
        const li = createTaskElement(task.text, task.desc, todoUl, doneUl, listObj.id);
        if (task.done) {
          li.querySelector('input[type="checkbox"]').checked = true;
          li.classList.add('done');
          doneUl.appendChild(li);
        } else {
          todoUl.appendChild(li);
        }
        enableTaskEdit(li, task.text, task.desc, listObj.id, task.done);
      });
    }

    function configureTodoListeners(cardElement, listObj) {
      const listId = cardElement.getAttribute('data-list-id');
      const form = cardElement.querySelector(`form[data-list-id="${listId}"]`);
      const todoUl = cardElement.querySelector('ul[data-type="todo"]');
      const doneUl = cardElement.querySelector('ul[data-type="done"]');

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const input = form.querySelector('input[type="text"]');
        const descInput = form.querySelector('input[name="description"]');
        const text = input.value.trim();
        const desc = descInput.value.trim();
        if (!text) return;
        const li = createTaskElement(text, desc, todoUl, doneUl, listId);
        todoUl.appendChild(li);
        const listData = todosData.find(l => l.id === listId);
        listData.tasks.push({ text, desc, done: false });
        saveTodos();
        enableTaskEdit(li, text, desc, listId, false);
        input.value = '';
        descInput.value = '';
        input.focus();
      });
    }

    function createTaskElement(text, desc, todoContainer, doneContainer, listId) {
      const li = document.createElement('li');

      const topRow = document.createElement('div');
      topRow.classList.add('task-content');

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';

      const label = document.createElement('span');
      label.textContent = text;
      label.classList.add('task-label');

      topRow.appendChild(checkbox);
      topRow.appendChild(label);
      li.appendChild(topRow);

      if (desc) {
        const descSpan = document.createElement('span');
        descSpan.textContent = desc;
        descSpan.classList.add('task-desc');
        li.appendChild(descSpan);
      }

      checkbox.addEventListener('change', () => {
        const listData = todosData.find(l => l.id === listId);
        const taskObj = listData.tasks.find(t => t.text === text && t.desc === desc && t.done === !checkbox.checked);
        if (checkbox.checked) {
          li.classList.add('done');
          doneContainer.appendChild(li);
          if (taskObj) taskObj.done = true;
        } else {
          li.classList.remove('done');
          todoContainer.appendChild(li);
          if (taskObj) taskObj.done = false;
        }
        saveTodos();
      });

      return li;
    }

    function enableTaskEdit(liElement, oldText, oldDesc, listId, isDone) {
      const label = liElement.querySelector('.task-label');
      const descSpan = liElement.querySelector('.task-desc');

      function startTextEdit() {
        const old = label.textContent;
        const inputEdit = document.createElement('input');
        inputEdit.type = 'text';
        inputEdit.value = old;
        inputEdit.classList.add('task-label-edit');
        liElement.replaceChild(inputEdit, label);
        inputEdit.focus();

        function saveEdit() {
          const newText = inputEdit.value.trim();
          if (newText) {
            const listData = todosData.find(l => l.id === listId);
            const taskObj = listData.tasks.find(t => t.text === oldText && t.desc === oldDesc && t.done === isDone);
            if (taskObj) taskObj.text = newText;
            saveTodos();
            label.textContent = newText;
            liElement.replaceChild(label, inputEdit);
          } else {
            liElement.replaceChild(label, inputEdit);
          }
        }

        inputEdit.addEventListener('blur', saveEdit);
        inputEdit.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit();
          } else if (e.key === 'Escape') {
            liElement.replaceChild(label, inputEdit);
          }
        });
      }

      label.addEventListener('dblclick', startTextEdit);
      label.addEventListener('touchend', (e) => {
        e.preventDefault();
        startTextEdit();
      });

      if (descSpan) {
        function startDescEdit() {
          const old = descSpan.textContent;
          const inputEdit = document.createElement('input');
          inputEdit.type = 'text';
          inputEdit.value = old;
          inputEdit.classList.add('task-desc-edit');
          liElement.replaceChild(inputEdit, descSpan);
          inputEdit.focus();

          function saveEdit() {
            const newDesc = inputEdit.value.trim();
            const listData = todosData.find(l => l.id === listId);
            const taskObj = listData.tasks.find(t => t.text === oldText && t.desc === oldDesc && t.done === isDone);
            if (taskObj) taskObj.desc = newDesc;
            saveTodos();
            descSpan.textContent = newDesc;
            liElement.replaceChild(descSpan, inputEdit);
          }

          inputEdit.addEventListener('blur', saveEdit);
          inputEdit.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
              e.preventDefault();
              saveEdit();
            } else if (e.key === 'Escape') {
              liElement.replaceChild(descSpan, inputEdit);
            }
          });
        }

        descSpan.addEventListener('dblclick', startDescEdit);
        descSpan.addEventListener('touchend', (e) => {
          e.preventDefault();
          startDescEdit();
        });
      }
    }

    function saveTodos() {
      localStorage.setItem(TODO_STORAGE_KEY, JSON.stringify(todosData));
    }

    function loadTodos() {
      const saved = localStorage.getItem(TODO_STORAGE_KEY);
      if (saved) {
        todosData = JSON.parse(saved);
        todosData.forEach(listObj => {
          const parts = listObj.id.split('-');
          const ts = parseInt(parts[2]);
          if (!isNaN(ts)) listCounter = Math.max(listCounter, ts);
          createTodoList(listObj);
        });
      }
    }

    /* ==========================
       SHOPPING LIST WITH FULL EDITING
    =========================== */
    const SHOPPING_STORAGE_KEY = 'myplanner_shopping';
    const shoppingForm = document.getElementById('new-item-form');
    const nameInput = document.getElementById('item-name-input');
    const qtyInput = document.getElementById('item-qty-input');
    const descInput = document.getElementById('item-desc-input');
    const shoppingTodoList = document.getElementById('shopping-todo-list');
    const shoppingDoneList = document.getElementById('shopping-done-list');
    let shoppingData = [];
    // Structure: [ { text, qty, desc, done } ]

    shoppingForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const nomeProdotto = nameInput.value.trim();
      const quantitaProdotto = qtyInput.value.trim();
      const desc = descInput.value.trim();
      if (!nomeProdotto || !quantitaProdotto) return;
      const itemObj = { text: nomeProdotto, qty: quantitaProdotto, desc, done: false };
      shoppingData.push(itemObj);
      saveShopping();
      const itemElement = createShoppingItem(itemObj);
      shoppingTodoList.appendChild(itemElement);
      nameInput.value = '';
      qtyInput.value = '';
      descInput.value = '';
      nameInput.focus();
    });

    function createShoppingItem(itemObj) {
      const li = document.createElement('li');

      const topRow = document.createElement('div');
      topRow.classList.add('item-content');

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';

      const infoDiv = document.createElement('div');
      infoDiv.classList.add('item-info');
      infoDiv.textContent = itemObj.text;

      const qtySpan = document.createElement('span');
      qtySpan.textContent = itemObj.qty;
      infoDiv.appendChild(qtySpan);

      topRow.appendChild(checkbox);
      topRow.appendChild(infoDiv);
      li.appendChild(topRow);

      if (itemObj.desc) {
        const descSpan = document.createElement('span');
        descSpan.textContent = itemObj.desc;
        descSpan.classList.add('item-desc');
        li.appendChild(descSpan);
      }

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Elimina';
      deleteBtn.classList.add('delete-item-button');

      deleteBtn.addEventListener('click', () => {
        li.remove();
        shoppingData = shoppingData.filter(i =>
          !(i.text === itemObj.text &&
            i.qty === itemObj.qty &&
            i.desc === itemObj.desc &&
            i.done === true)
        );
        saveShopping();
      });

      if (itemObj.done) {
        checkbox.checked = true;
        li.classList.add('done');
        shoppingDoneList.appendChild(li);
        deleteBtn.style.display = 'block';
      }

      checkbox.addEventListener('change', () => {
        itemObj.done = checkbox.checked;
        if (checkbox.checked) {
          li.classList.add('done');
          shoppingDoneList.appendChild(li);
          deleteBtn.style.display = 'block';
        } else {
          li.classList.remove('done');
          shoppingTodoList.appendChild(li);
          deleteBtn.style.display = 'none';
        }
        saveShopping();
      });

      function startItemTextEdit() {
        const oldName = infoDiv.textContent.split('\n')[0];
        const oldQty = itemObj.qty;
        const oldDesc = itemObj.desc;

        const editDiv = document.createElement('div');
        editDiv.classList.add('item-info-edit');

        const nameInputEdit = document.createElement('input');
        nameInputEdit.type = 'text';
        nameInputEdit.value = oldName;

        const qtyInputEdit = document.createElement('input');
        qtyInputEdit.type = 'text';
        qtyInputEdit.value = oldQty;

        editDiv.appendChild(nameInputEdit);
        editDiv.appendChild(qtyInputEdit);

        li.replaceChild(editDiv, infoDiv);
        nameInputEdit.focus();

        function saveEdit() {
          const newName = nameInputEdit.value.trim();
          const newQty = qtyInputEdit.value.trim();
          if (newName && newQty) {
            itemObj.text = newName;
            itemObj.qty = newQty;
            saveShopping();
            infoDiv.textContent = newName;
            const spanQty = document.createElement('span');
            spanQty.textContent = newQty;
            infoDiv.appendChild(spanQty);
            li.replaceChild(infoDiv, editDiv);
          } else {
            li.replaceChild(infoDiv, editDiv);
          }
        }

        nameInputEdit.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            saveEdit();
          } else if (e.key === 'Escape') {
            li.replaceChild(infoDiv, editDiv);
          }
        });
        qtyInputEdit.addEventListener('keydown', e => {
          if (e.key === 'Enter') {
            saveEdit();
          } else if (e.key === 'Escape') {
            li.replaceChild(infoDiv, editDiv);
          }
        });
        nameInputEdit.addEventListener('blur', saveEdit);
        qtyInputEdit.addEventListener('blur', saveEdit);
      }

      infoDiv.addEventListener('dblclick', startItemTextEdit);
      infoDiv.addEventListener('touchend', (e) => {
        e.preventDefault();
        startItemTextEdit();
      });

      const descSpan = li.querySelector('.item-desc');
      if (descSpan) {
        function startItemDescEdit() {
          const old = descSpan.textContent;
          const inputEdit = document.createElement('input');
          inputEdit.type = 'text';
          inputEdit.value = old;
          inputEdit.classList.add('item-desc-edit');
          li.replaceChild(inputEdit, descSpan);
          inputEdit.focus();

          function saveEdit() {
            const newDesc = inputEdit.value.trim();
            itemObj.desc = newDesc;
            saveShopping();
            descSpan.textContent = newDesc;
            li.replaceChild(descSpan, inputEdit);
          }

          inputEdit.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
              saveEdit();
            } else if (e.key === 'Escape') {
              li.replaceChild(descSpan, inputEdit);
            }
          });
          inputEdit.addEventListener('blur', saveEdit);
        }

        descSpan.addEventListener('dblclick', startItemDescEdit);
        descSpan.addEventListener('touchend', (e) => {
          e.preventDefault();
          startItemDescEdit();
        });
      }

      li.appendChild(deleteBtn);
      return li;
    }

    function saveShopping() {
      localStorage.setItem(SHOPPING_STORAGE_KEY, JSON.stringify(shoppingData));
    }

    function loadShopping() {
      const saved = localStorage.getItem(SHOPPING_STORAGE_KEY);
      if (saved) {
        shoppingData = JSON.parse(saved);
        shoppingData.forEach(itemObj => {
          const li = createShoppingItem(itemObj);
          if (itemObj.done) {
            shoppingDoneList.appendChild(li);
          } else {
            shoppingTodoList.appendChild(li);
          }
        });
      }
    }

    /* ==========================
       PRICE COMPARISON WITH EDITABLE NAMES
    =========================== */
    const COMP_STORAGE_KEY = 'myplanner_comparison';
    const addProductForm = document.getElementById('add-product-form');
    const productNameInput = document.getElementById('product-name-input');
    const addStoreForm = document.getElementById('add-store-form');
    const storeNameInput = document.getElementById('store-name-input');
    const comparisonTable = document.getElementById('comparison-table');
    const theadRow = comparisonTable.querySelector('thead tr');
    const tbodyComp = comparisonTable.querySelector('tbody');

    let compData = { products: [], stores: [] };
    // products: [ productName, ... ]
    // stores:   [ { name, prices: [ stringValue | "" , ... ] }, ... ]

    addProductForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const productName = productNameInput.value.trim();
      if (!productName) return;
      compData.products.push(productName);
      compData.stores.forEach(storeObj => storeObj.prices.push(""));

      const th = document.createElement('th');
      const headerSpan = document.createElement('span');
      headerSpan.textContent = productName;
      headerSpan.style.flex = '1';
      headerSpan.style.cursor = 'pointer';

      // Double-click or tap to edit product name
      function startProductEdit() {
        const oldName = headerSpan.textContent;
        const inputEdit = document.createElement('input');
        inputEdit.type = 'text';
        inputEdit.value = oldName;
        inputEdit.classList.add('edit-input');
        th.replaceChild(inputEdit, headerSpan);
        inputEdit.focus();

        function saveEdit() {
          const newName = inputEdit.value.trim();
          if (newName) {
            const idx = compData.products.indexOf(oldName);
            if (idx !== -1) {
              compData.products[idx] = newName;
            }
            saveComparison();
            headerSpan.textContent = newName;
            th.replaceChild(headerSpan, inputEdit);
          } else {
            th.replaceChild(headerSpan, inputEdit);
          }
        }
        inputEdit.addEventListener('blur', saveEdit);
        inputEdit.addEventListener('keydown', ev => {
          if (ev.key === 'Enter') {
            ev.preventDefault();
            saveEdit();
          } else if (ev.key === 'Escape') {
            th.replaceChild(headerSpan, inputEdit);
          }
        });
      }
      headerSpan.addEventListener('dblclick', startProductEdit);
      headerSpan.addEventListener('touchend', (e) => {
        e.preventDefault();
        startProductEdit();
      });

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'âœ•';
      deleteBtn.classList.add('delete-button');
      deleteBtn.title = 'Rimuovi prodotto';
      deleteBtn.style.marginLeft = '6px';
      deleteBtn.addEventListener('click', () => {
        removeProductColumn(productName);
      });

      th.appendChild(headerSpan);
      th.appendChild(deleteBtn);
      theadRow.appendChild(th);

      Array.from(tbodyComp.rows).forEach((row, rowIndex) => {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'â‚¬';
        input.value = compData.stores[rowIndex].prices[compData.products.length - 1];
        input.addEventListener('input', () => {
          compData.stores[rowIndex].prices[compData.products.length - 1] = input.value;
          saveComparison();
          updateHighlights();
        });
        td.appendChild(input);
        row.appendChild(td);
      });

      saveComparison();
      productNameInput.value = '';
      productNameInput.focus();
      updateHighlights();
    });

    addStoreForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const storeName = storeNameInput.value.trim();
      if (!storeName) return;

      const newStoreObj = { name: storeName, prices: Array(compData.products.length).fill("") };
      compData.stores.push(newStoreObj);

      const tr = document.createElement('tr');
      const tdName = document.createElement('td');
      const nameSpan = document.createElement('span');
      nameSpan.textContent = storeName;
      nameSpan.style.flex = '1';
      nameSpan.style.cursor = 'pointer';

      // Double-click or tap to edit store name
      function startStoreEdit() {
        const oldName = nameSpan.textContent;
        const inputEdit = document.createElement('input');
        inputEdit.type = 'text';
        inputEdit.value = oldName;
        inputEdit.classList.add('edit-input');
        tdName.replaceChild(inputEdit, nameSpan);
        inputEdit.focus();

        function saveEdit() {
          const newName = inputEdit.value.trim();
          if (newName) {
            const storeIdx = compData.stores.findIndex(s => s.name === oldName);
            if (storeIdx !== -1) {
              compData.stores[storeIdx].name = newName;
            }
            saveComparison();
            nameSpan.textContent = newName;
            tdName.replaceChild(nameSpan, inputEdit);
          } else {
            tdName.replaceChild(nameSpan, inputEdit);
          }
        }
        inputEdit.addEventListener('blur', saveEdit);
        inputEdit.addEventListener('keydown', ev => {
          if (ev.key === 'Enter') {
            ev.preventDefault();
            saveEdit();
          } else if (ev.key === 'Escape') {
            tdName.replaceChild(nameSpan, inputEdit);
          }
        });
      }
      nameSpan.addEventListener('dblclick', startStoreEdit);
      nameSpan.addEventListener('touchend', (e) => {
        e.preventDefault();
        startStoreEdit();
      });

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'âœ•';
      deleteBtn.classList.add('delete-button');
      deleteBtn.title = 'Rimuovi supermercato';
      deleteBtn.addEventListener('click', () => {
        tr.remove();
        compData.stores = compData.stores.filter(s => s.name !== storeName);
        saveComparison();
        updateHighlights();
      });

      tdName.style.display = 'flex';
      tdName.style.alignItems = 'center';
      tdName.style.justifyContent = 'space-between';
      tdName.appendChild(nameSpan);
      tdName.appendChild(deleteBtn);
      tr.appendChild(tdName);

      newStoreObj.prices.forEach((priceVal, idx) => {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'â‚¬';
        input.value = priceVal;
        input.addEventListener('input', () => {
          newStoreObj.prices[idx] = input.value;
          saveComparison();
          updateHighlights();
        });
        td.appendChild(input);
        tr.appendChild(td);
      });

      tbodyComp.appendChild(tr);
      saveComparison();
      storeNameInput.value = '';
      storeNameInput.focus();
    });

    function removeProductColumn(productName) {
      const index = compData.products.indexOf(productName);
      if (index === -1) return;
      compData.products.splice(index, 1);
      compData.stores.forEach(storeObj => storeObj.prices.splice(index, 1));

      const ths = Array.from(theadRow.querySelectorAll('th'));
      const thToRemove = ths[index + 1]; // +1 perchÃ© prima colonna Ã¨ â€œSupermercatoâ€
      theadRow.removeChild(thToRemove);

      Array.from(tbodyComp.rows).forEach(row => {
        row.removeChild(row.children[index + 1]);
      });

      saveComparison();
      updateHighlights();
    }

    function updateHighlights() {
      const colCount = compData.products.length;

      // Rimuovi tutte le evidenziazioni
      Array.from(tbodyComp.rows).forEach(row => {
        for (let c = 1; c <= colCount; c++) {
          row.children[c].classList.remove('lowest-price');
        }
      });

      // Per ogni colonna (prodotto), individua prezzo minimo
      for (let colIndex = 0; colIndex < colCount; colIndex++) {
        let minPrice = Infinity;
        let candidateCells = [];

        Array.from(tbodyComp.rows).forEach((row, rowIndex) => {
          const cell = row.children[colIndex + 1];
          const input = cell.querySelector('input');
          const val = parseFloat(input.value.replace(',', '.'));
          if (!isNaN(val)) {
            if (val < minPrice) {
              minPrice = val;
              candidateCells = [cell];
            } else if (val === minPrice) {
              candidateCells.push(cell);
            }
          }
        });

        candidateCells.forEach(cell => {
          cell.classList.add('lowest-price');
        });
      }
    }

    function saveComparison() {
      localStorage.setItem(COMP_STORAGE_KEY, JSON.stringify(compData));
    }

    function loadComparison() {
      const saved = localStorage.getItem(COMP_STORAGE_KEY);
      if (saved) {
        compData = JSON.parse(saved);
        compData.products.forEach(productName => {
          const th = document.createElement('th');
          const headerSpan = document.createElement('span');
          headerSpan.textContent = productName;
          headerSpan.style.flex = '1';
          headerSpan.style.cursor = 'pointer';

          function startProductEdit() {
            const oldName = headerSpan.textContent;
            const inputEdit = document.createElement('input');
            inputEdit.type = 'text';
            inputEdit.value = oldName;
            inputEdit.classList.add('edit-input');
            th.replaceChild(inputEdit, headerSpan);
            inputEdit.focus();

            function saveEdit() {
              const newName = inputEdit.value.trim();
              if (newName) {
                const idx = compData.products.indexOf(oldName);
                if (idx !== -1) {
                  compData.products[idx] = newName;
                }
                saveComparison();
                headerSpan.textContent = newName;
                th.replaceChild(headerSpan, inputEdit);
              } else {
                th.replaceChild(headerSpan, inputEdit);
              }
            }
            inputEdit.addEventListener('blur', saveEdit);
            inputEdit.addEventListener('keydown', ev => {
              if (ev.key === 'Enter') {
                ev.preventDefault();
                saveEdit();
              } else if (ev.key === 'Escape') {
                th.replaceChild(headerSpan, inputEdit);
              }
            });
          }
          headerSpan.addEventListener('dblclick', startProductEdit);
          headerSpan.addEventListener('touchend', (e) => {
            e.preventDefault();
            startProductEdit();
          });

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'âœ•';
          deleteBtn.classList.add('delete-button');
          deleteBtn.title = 'Rimuovi prodotto';
          deleteBtn.style.marginLeft = '6px';
          deleteBtn.addEventListener('click', () => {
            removeProductColumn(productName);
          });

          th.appendChild(headerSpan);
          th.appendChild(deleteBtn);
          theadRow.appendChild(th);
        });
        compData.stores.forEach(storeObj => {
          const tr = document.createElement('tr');
          const tdName = document.createElement('td');
          const nameSpan = document.createElement('span');
          nameSpan.textContent = storeObj.name;
          nameSpan.style.flex = '1';
          nameSpan.style.cursor = 'pointer';

          function startStoreEdit() {
            const oldName = nameSpan.textContent;
            const inputEdit = document.createElement('input');
            inputEdit.type = 'text';
            inputEdit.value = oldName;
            inputEdit.classList.add('edit-input');
            tdName.replaceChild(inputEdit, nameSpan);
            inputEdit.focus();

            function saveEdit() {
              const newName = inputEdit.value.trim();
              if (newName) {
                const storeIdx = compData.stores.findIndex(s => s.name === oldName);
                if (storeIdx !== -1) {
                  compData.stores[storeIdx].name = newName;
                }
                saveComparison();
                nameSpan.textContent = newName;
                tdName.replaceChild(nameSpan, inputEdit);
              } else {
                tdName.replaceChild(nameSpan, inputEdit);
              }
            }
            inputEdit.addEventListener('blur', saveEdit);
            inputEdit.addEventListener('keydown', ev => {
              if (ev.key === 'Enter') {
                ev.preventDefault();
                saveEdit();
              } else if (ev.key === 'Escape') {
                tdName.replaceChild(nameSpan, inputEdit);
              }
            });
          }
          nameSpan.addEventListener('dblclick', startStoreEdit);
          nameSpan.addEventListener('touchend', (e) => {
            e.preventDefault();
            startStoreEdit();
          });

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'âœ•';
          deleteBtn.classList.add('delete-button');
          deleteBtn.title = 'Rimuovi supermercato';
          deleteBtn.addEventListener('click', () => {
            tr.remove();
            compData.stores = compData.stores.filter(s => s.name !== storeObj.name);
            saveComparison();
            updateHighlights();
          });

          tdName.style.display = 'flex';
          tdName.style.alignItems = 'center';
          tdName.style.justifyContent = 'space-between';
          tdName.appendChild(nameSpan);
          tdName.appendChild(deleteBtn);
          tr.appendChild(tdName);

          storeObj.prices.forEach((priceVal, idx) => {
            const td = document.createElement('td');
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'â‚¬';
            input.value = priceVal;
            input.addEventListener('input', () => {
              storeObj.prices[idx] = input.value;
              saveComparison();
              updateHighlights();
            });
            td.appendChild(input);
            tr.appendChild(td);
          });

          tbodyComp.appendChild(tr);
        });
        updateHighlights();
      }
    }

    /* ==========================
       LOAD ALL DATA ON STARTUP
    =========================== */
    document.addEventListener('DOMContentLoaded', () => {
      loadTodos();
      loadShopping();
      loadComparison();
    });
  </script>
</body>
</html>
